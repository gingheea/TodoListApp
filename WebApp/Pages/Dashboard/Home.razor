@page "/home"
@using Blazored.LocalStorage
@using Microsoft.AspNetCore.Components.Authorization
@using TodoListApp.WebApp.Model
@using TodoListApp.WebApp.Service
@using TodoListApp.WebApp.src.Components
@inject AuthenticationStateProvider AuthStateProvider
@inject DashboardService DashboardService
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavManager

<main class="page-wrapper"> 
    <section id="dashboard-overview" class="dashboard-overview">
        <Navigation />
        <div class="dashboard-container">
            <!-- LEFT COLUMN -->
            <div class="greeting-column">
                <h1 class="hero-title">Good morning, @userName</h1>
                <p class="hero-subtitle">Welcome back.</p>
                <p class="hero-tagline">
                    Focus on what matters. Create a task, switch views, or jump into your day with one tap.
                </p>

                <div role="tablist" class="view-tabs">
                    <button role="tab"
                    class="tab-btn @(activeTab == "all" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("all"))">
                        All
                    </button>
                    <button role="tab"
                    class="tab-btn @(activeTab == "upcoming" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("upcoming"))">
                        Upcoming
                    </button>
                    <button role="tab"
                    class="tab-btn @(activeTab == "completed" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("completed"))">
                        Completed
                    </button>
                </div>
            </div>

            <!-- MIDDLE COLUMN -->
            <div class="middle-column">
                <button class="btn btn-primary btn-new-task" @onclick="CreateNewTask">
                    <svg width="24" height="24" viewBox="0 0 24 24">
                        <path d="M5 12h14m-7-7v14" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <span>New Task</span>
                </button>

                <div class="metrics-row">
                    <div class="metric-widget">
                        <div class="metric-value"><span>@tasksDue</span></div>
                        <div class="metric-label"><span>Tasks due</span></div>
                    </div>
                    <div class="metric-widget">
                        <div class="metric-value"><span>@totalTasks</span></div>
                        <div class="metric-label"><span>Total tasks</span></div>
                    </div>
                    <div class="metric-widget">
                        <div class="metric-value"><span>@completedTasks</span>%</div>
                        <div class="metric-label"><span>Complete</span></div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="profile-column">
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="avatar">
                            <svg width="24" height="24" viewBox="0 0 24 24">
                                <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                                    <circle r="4" cx="12" cy="7"></circle>
                                </g>
                            </svg>
                        </div>
                        <div class="profile-info">
                            <div class="profile-name"><span>@userName</span></div>
                            <div class="profile-badge"><span>@userRole</span></div>
                        </div>
                    </div>

                    <div class="quick-actions">

                        <button aria-label="Schedule" class="action-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24">
                                <g fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M8 2v4m8-4v4"></path>
                                    <rect x="3" y="4" rx="2" width="18" height="18"></rect>
                                    <path d="M3 10h18"></path>
                                </g>
                            </svg>
                            <span>Schedule</span>
                        </button>

                    </div>
                </div>
            </div>
        </div>
    </section>
    <Footer />
</main>

@code {
    private DashboardModel? dashboard;
    private string userName = "User";
    private string userRole = "Standard";
    private int tasksDue = 0;
    private double totalTasks = 0;
    private int completedTasks = 0;
    private string activeTab = "today";



    protected override async Task OnInitializedAsync()
    {
        var token = await LocalStorage.GetItemAsStringAsync("authToken");
        if (string.IsNullOrEmpty(token))
        {
            NavManager.NavigateTo("/login", true);
            return;
        }
        dashboard = await DashboardService.GetDashboardAsync();

        if (dashboard != null)
        {
            userName = dashboard.UserName;
            userRole = dashboard.Role;
            tasksDue = dashboard.TasksDue;
            totalTasks = dashboard.TotalCount;
            completedTasks = (int)dashboard.CompletionPercent;
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        NavManager.NavigateTo($"/home/{tab}/tasks", true);
    }

    private void CreateNewTask()
    {
        NavManager.NavigateTo("/home/todolist", true);
    }
}
