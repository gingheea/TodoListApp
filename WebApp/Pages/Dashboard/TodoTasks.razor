#pragma warning disable CS0649
#pragma warning disable S3459
#pragma warning disable S1144
@page "/home/todolist/{listId:int}/tasks"
@using Blazored.LocalStorage
@using TodoListApp.WebApp.Model
@using TodoListApp.WebApp.Service
@using TodoListApp.WebApp.src.Components
@inject TodoItemService TodoItemService
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime
@inject ILocalStorageService LocalStorage


<main class="page-wrapper">
    <section id="task-list" class="task-list-section  dashboard-overview">
        <Navigation />
        <div class="task-panel-wrapper">
            <div class="main-task-column">
                <div class="task-header">
                    <h2 class="section-title">My Tasks</h2>
                    <p class="section-subtitle">Tasks for this list</p>
                </div>

                <button class="btn-show-create" @onclick="ToggleCreateTaskSection">
                    + Create Task
                </button>

                @if (showCreateTaskSection)
                {
                    <div class="create-task-section">
                        <div class="create-list-wrapper">
                            <input type="text" class="create-list-input" placeholder="Task title..."
                            @bind="newTaskTitle" @ref="createTaskInputRef" />/>

                            <textarea class="create-list-input" placeholder="Description..."
                            @bind="newTaskDescription"></textarea>

                            <input type="date" class="create-list-input"
                            @bind="newTaskDueDate" />

                            <button class="btn-create btn btn-primary" @onclick="CreateNewTask">Add Task</button>
                        </div>
                    </div>
                }

                @* <div class="task-tabs">
                    <button class="task-tab @(activeFilter == "Upcoming" ? "active" : "")" @onclick="@(() => SetFilter("Upcoming"))">Upcoming</button>
                </div> *@


                <div class="tasks-container">
                    @if (tasks == null)
                    {
                        <p>Loading tasks...</p>
                    }
                    else if (!tasks.Any())
                    {
                        <div class="empty-state">
                            <img src="/images/empty-tasks.svg" alt="No tasks" class="empty-image" />
                            <h3>No tasks yet</h3>
                            <p>Create your first task to start organizing your work!</p>
                            <button class="btn btn-primary" @onclick="FocusCreateTaskInput">Create a Task</button>
                        </div>
                    }
                    else
                    {
                        @foreach (var task in FilteredTasks)
                        {
                            <div class="task-item @(task.IsCompleted ? "completed" : GetTaskStatusClass(task))">
                                <button role="button" aria-label="Drag to reorder" class="drag-handle">
                                    <svg width="20" height="20" viewBox="0 0 24 24">
                                        <path d="M4 5h16M4 12h16M4 19h16"
                                        fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round"></path>
                                    </svg>
                                </button>

                                <div class="task-content">
                                    @if (editingTaskId == task.Id)
                                    {
                                        <div class="task-content" @onkeyup="@(e => HandleEditKey(e, task))">
                                            <input type="text" class="edit-list-input" @bind="editTitle" autofocus />

                                            <textarea class="edit-list-input"
                                            @bind="editDescription"
                                            @bind:event="oninput"
                                            placeholder="Description"></textarea>

                                            <input type="date" class="edit-list-input" @bind="editDueDate" />
                                        </div>
                                    }
                                    else
                                    {
                                        <h3 class="task-title @(task.IsCompleted ? "completed-title" : "")">@task.Title</h3>
                                        @if (!string.IsNullOrWhiteSpace(task.Description))
                                        {
                                            <p class="task-meta">@task.Description</p>
                                        }
                                    }

                                    <div class="task-details">
                                        @if (task.DueDate != null)
                                        {
                                            <span class="task-due">Due: @task.DueDate?.ToString("dd.MM.yyyy")</span>
                                        }
                                        <span class="task-status @(task.IsCompleted ? "completed" : "")">
                                            Status: @(task.IsCompleted ? "completed" : GetTaskStatusText(task))
                                        </span>
                                    </div>
                                </div>

                                <div class="task-controls">
                                    <button aria-label="Edit task" class="task-action" @onclick="() => StartEditing(task)">
                                        <svg width="18" height="18" viewBox="0 0 24 24">
                                            <g fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"></path>
                                            </g>
                                        </svg>
                                    </button>

                                    <button aria-label="Complete task" class="task-action" @onclick="() => ToggleComplete(task)">
                                        <svg width="18" height="18" viewBox="0 0 24 24">
                                            <path d="M20 6L9 17l-5-5"
                                            fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"></path>
                                        </svg>
                                    </button>

                                    <button aria-label="Delete task" class="task-action delete" @onclick="() => DeleteTask(task.Id)">
                                        <svg width="18" height="18" viewBox="0 0 24 24">
                                            <g fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m5 0V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2"></path>
                                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                                <line x1="14" y1="11" x2="14" y2="17"></line>
                                            </g>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        }
                    }
                </div>

            </div>

            <div class="side-column">
                <div class="progress-card">
                    <h3 class="card-heading">Progress</h3>
                    <div class="progress-stats">
                        <div class="progress-value"><span>@completedTasks of @totalTasks</span></div>
                        <div class="progress-label"><span>Tasks complete</span></div>
                        <div class="progress-percentage"><span>@progressPercent% done</span></div>
                    </div>
                    <div class="progress-bar">
                        <div class="dashboard-progress-fill progress-fill"
                        style="width:@($"{progressPercent}%")"></div>
                    </div>
                </div>

                <div class="filter-card">
                    <h3 class="card-heading">Filter</h3>
                    <div class="filter-options">
                        <button class="filter-option @(activeFilter == "All" ? "active" : "")" @onclick="@(() => SetFilter("All"))">All</button>
                        <button class="filter-option @(activeFilter == "InProgres" ? "active" : "")" @onclick="@(() => SetFilter("InProgres"))">In progres</button>
                        <button class="filter-option @(activeFilter == "Overdue" ? "active" : "")" @onclick="@(() => SetFilter("Overdue"))">Overdue</button>
                        <button class="filter-option @(activeFilter == "Completed" ? "active" : "")" @onclick="@(() => SetFilter("Completed"))">Completed</button>
                    </div>
                </div>
            </div>
        </div>

        <button aria-label="Quick add task" class="floating-add">
            <svg width="24" height="24" viewBox="0 0 24 24">
                <path d="M5 12h14m-7-7v14"
                fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </section>
    <Footer />
</main>

@code {
    [Parameter] public int listId { get; set; }

    private List<TodoItemModel>? tasks;

    private bool showCreateTaskSection = false;
    private string newTaskTitle = string.Empty;
    private string newTaskDescription = string.Empty;
    private DateTime? newTaskDueDate = null;

    private int? editingTaskId = null;
    private string editTitle = string.Empty;
    private string editDescription = string.Empty;
    private DateTime? editDueDate = null;

    private ElementReference createTaskInputRef;
    private string activeFilter = "All";

    private int totalTasks => tasks?.Count ?? 0;
    private int completedTasks => tasks?.Count(t => t.IsCompleted) ?? 0;

    private double progressPercent => totalTasks == 0
        ? 0
        : Math.Round((double)completedTasks / totalTasks * 100, 1);

    protected override async Task OnInitializedAsync()
    {
        var token = await LocalStorage.GetItemAsStringAsync("authToken");
        if (string.IsNullOrEmpty(token))
        {
            NavManager.NavigateTo("/login", true);
            return;
        }

        tasks = await TodoItemService.GetTasksByListIdAsync(listId);
    }

    private void SetFilter(string filter)
    {
        activeFilter = filter;
        StateHasChanged();
    }

    private IEnumerable<TodoItemModel> FilteredTasks
    {
        get
        {
            if (tasks == null) return Enumerable.Empty<TodoItemModel>();
            var today = DateTime.Today;

            IEnumerable<TodoItemModel> query = activeFilter switch
            {
                "All" => tasks,
                "Upcoming" => tasks.OrderBy(t => t.DueDate),
                "Completed" => tasks.Where(t => t.IsCompleted)
                                   .OrderByDescending(t => t.DueDate),
                "InProgres" => tasks.Where(t => !t.IsCompleted),
                "Overdue" => tasks.Where(t => t.DueDate != null && t.DueDate < today && !t.IsCompleted)
                                   .OrderBy(t => t.DueDate),
                _ => tasks
            };

            return query.OrderBy(t => t.IsCompleted)
                        .ThenBy(t => t.DueDate ?? DateTime.MaxValue);
        }
    }

    private string GetTaskStatusClass(TodoItemModel task)
    {
        if (task.DueDate == null)
        {
            return "";
        }

        var today = DateTime.Today;
        var daysLeft = (task.DueDate.Value.Date - today).TotalDays;

        if (daysLeft < 0)
        {
            return "overdue-status";
        }
        if (daysLeft <= 2)
        {
            return "almost-due-status";
        }
        return "";
    }

    private string GetTaskStatusText(TodoItemModel task)
    {
        if (task.DueDate == null)
        {
            return "In progress";
        }

        var today = DateTime.Today;
        var daysLeft = (task.DueDate.Value.Date - today).TotalDays;

        if (daysLeft < 0)
        {
            return "Overdue";
        }
        if (daysLeft <= 2)
        {
            return "Due soon";
        }


        return "In progress";
    }

    private void ToggleCreateTaskSection()
    {
        showCreateTaskSection = !showCreateTaskSection;
    }

    private async Task CreateNewTask()
    {
        if (string.IsNullOrWhiteSpace(newTaskTitle))
        {
            return;
        }

        var newTask = new TodoItemCreateModel
            {
                Title = newTaskTitle,
                Description = newTaskDescription,
                DueDate = newTaskDueDate,
            };

        var success = await TodoItemService.CreateTaskAsync(listId, newTask);
        if (success)
        {
            newTaskTitle = string.Empty;
            newTaskDescription = string.Empty;
            newTaskDueDate = null;
            showCreateTaskSection = false;

            tasks = await TodoItemService.GetTasksByListIdAsync(listId);
            StateHasChanged();
        }
    }


    private void StartEditing(TodoItemModel task)
    {
        editingTaskId = task.Id;
        editTitle = task.Title;
        editDescription = task.Description ?? "";
        editDueDate = task.DueDate;

    }

    private async Task SaveTaskChanges(TodoItemModel task)
    {
        var updatedTask = new TodoItemUpdateModel
            {
                Title = editTitle,
                Description = editDescription,
                DueDate = editDueDate ?? DateTime.Today,
                IsCompleted = task.IsCompleted
            };

        var success = await TodoItemService.UpdateTaskAsync(listId, task.Id, updatedTask);
        if (success)
        {
            task.Title = editTitle;
            task.Description = editDescription;
            task.DueDate = editDueDate;

            CancelEditing();
            tasks = await TodoItemService.GetTasksByListIdAsync(listId);

            StateHasChanged();
        }
    }

    private void CancelEditing()
    {
        editingTaskId = null;
    }



    private async Task HandleEditKey(KeyboardEventArgs e, TodoItemModel task)
    {
        if (e.Key == "Enter")
        {
            await Task.Delay(1);
            await SaveTaskChanges(task);
        }  
        else if (e.Key == "Escape")
        {
            CancelEditing();
        }
    }

    private async Task DeleteTask(int taskId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this task?");
        if (!confirmed) return;

        var success = await TodoItemService.DeleteTaskAsync(listId, taskId);
        if (success)
        {
            tasks = await TodoItemService.GetTasksByListIdAsync(listId);
        }
        
    }

    private async Task ToggleComplete(TodoItemModel task)
    {
        var desired = !task.IsCompleted;
        var ok = await TodoItemService.ToggleCompleteAsync(listId, task.Id, desired);

        if (ok)
        {
            task.IsCompleted = desired;
            StateHasChanged();
        }
        else
        {
            Console.WriteLine("Failed to toggle status");
        }
    }

    private async Task FocusCreateTaskInput()
    {
        await Task.Delay(100);
        await createTaskInputRef.FocusAsync();
    }
}